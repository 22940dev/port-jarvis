<!-- Automatic resizing for HiDPI/retina images -->

{{- $original := .Page.Resources.GetMatch (.Get "src") -}}
{{- .Scratch.Set "image" $original -}}

<!-- TODO: automatically pull max-width of page -->
{{- $maxWidth := 910 -}}

{{- if .Get "width" }}
  {{- $inputWidth := (int (.Get "width")) -}}
  {{- $retinaWidth := (mul $inputWidth 2) -}}

  {{- if gt $original.Width $retinaWidth -}}
    {{- $finalWidth := (printf "%dx" $retinaWidth ) -}}
    {{- .Scratch.Set "image" ($original.Resize $finalWidth) -}}
  {{- end -}}
{{- else -}}
  {{- $inputWidth := $maxWidth -}}
  {{- if gt $original.Width 1820 -}}
    {{- .Scratch.Set "image" ($original.Resize "1820x") -}}
  {{- end -}}
{{- end -}}

{{- $image := .Scratch.Get "image" -}}

{{- $displayWidth := (math.Round (div $image.Width 2)) -}}
{{- $displayHeight := (math.Round (div $image.Height 2)) -}}

{{- if .Get "caption" -}}
<figure>
  <picture>
{{- else -}}
<p>
{{- end -}}
<img src="{{ $image.Permalink }}" width="{{ $displayWidth }}" height="{{ $displayHeight }}"{{ if .Get "alt" }} alt="{{ .Get "alt" }}"{{ end }}{{ if .Get "caption" }} title="{{ .Get "caption"}}"{{ end }}>
{{- if .Get "caption" -}}
  </picture>
  <figcaption>{{ .Get "caption" }}</figcaption>
</figure>
{{- else -}}
</p>
{{- end -}}
